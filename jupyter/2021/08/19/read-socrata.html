<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Show Me the City Data | The City Scraper</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Show Me the City Data" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="A tutorial for programatically reading Open Data from a Socrata database." />
<meta property="og:description" content="A tutorial for programatically reading Open Data from a Socrata database." />
<link rel="canonical" href="https://jmbahr.github.io/the-city-scraper/jupyter/2021/08/19/read-socrata.html" />
<meta property="og:url" content="https://jmbahr.github.io/the-city-scraper/jupyter/2021/08/19/read-socrata.html" />
<meta property="og:site_name" content="The City Scraper" />
<meta property="og:image" content="https://jmbahr.github.io/the-city-scraper/images/cincy_skyline.jpg" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-08-19T00:00:00-05:00" />
<script type="application/ld+json">
{"datePublished":"2021-08-19T00:00:00-05:00","url":"https://jmbahr.github.io/the-city-scraper/jupyter/2021/08/19/read-socrata.html","@type":"BlogPosting","image":"https://jmbahr.github.io/the-city-scraper/images/cincy_skyline.jpg","headline":"Show Me the City Data","dateModified":"2021-08-19T00:00:00-05:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://jmbahr.github.io/the-city-scraper/jupyter/2021/08/19/read-socrata.html"},"description":"A tutorial for programatically reading Open Data from a Socrata database.","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/the-city-scraper/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://jmbahr.github.io/the-city-scraper/feed.xml" title="The City Scraper" /><link rel="shortcut icon" type="image/x-icon" href="/the-city-scraper/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.css" integrity="sha512-h7nl+xz8wgDlNM4NqKEM4F1NkIRS17M9+uJwIGwuo8vGqIl4BhuCKdxjWEINm+xyrUjNCnK5dCrhM0sj+wTIXw==" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.js" integrity="sha512-/CMIhXiDA3m2c9kzRyd97MTb3MC6OVnx4TElQ7fkkoRghwDf6gi41gaT1PwF270W6+J60uTmwgeRpNpJdRV6sg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/contrib/auto-render.min.js" integrity="sha512-Do7uJAaHZm5OLrIv/yN4w0iG1dbu01kzdMNnFfu/mAqgUk6Nniv2JYHcwH+cNwjqgLcqcuBBk+JRvprLVI8azg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha512-0doc9hKxR3PYwso42RD1p5ySZpzzuDiOwMrdCEh2WdJZCjcmFKc/wEnL+z8fBQrnHoiNWbo+3fiGkOYXBdQp4A==" crossorigin="anonymous"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
        ]}
        );
    });
    </script>


<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/the-city-scraper/">The City Scraper</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/the-city-scraper/about/">About Me</a><a class="page-link" href="/the-city-scraper/search/">Search</a><a class="page-link" href="/the-city-scraper/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Show Me the City Data</h1><p class="page-description">A tutorial for programatically reading Open Data from a Socrata database.</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2021-08-19T00:00:00-05:00" itemprop="datePublished">
        Aug 19, 2021
      </time>
       • <span class="read-time" title="Estimated read time">
    
    
      10 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/the-city-scraper/categories/#jupyter">jupyter</a>
        
      
      </p>
    

    
      
        <div class="pb-5 d-flex flex-wrap flex-justify-end">
          <div class="px-2">

    <a href="https://github.com/jmbahr/the-city-scraper/tree/master/_notebooks/2021-08-19-read-socrata.ipynb" role="button" target="_blank">
<img class="notebook-badge-image" src="/the-city-scraper/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div>

          <div class="px-2">
    <a href="https://mybinder.org/v2/gh/jmbahr/the-city-scraper/master?filepath=_notebooks%2F2021-08-19-read-socrata.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/the-city-scraper/assets/badges/binder.svg" alt="Open In Binder"/>
    </a>
</div>

          <div class="px-2">
    <a href="https://colab.research.google.com/github/jmbahr/the-city-scraper/blob/master/_notebooks/2021-08-19-read-socrata.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/the-city-scraper/assets/badges/colab.svg" alt="Open In Colab"/>
    </a>
</div>
        </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul class="section-nav">
<li class="toc-entry toc-h2"><a href="#In-this-Post">In this Post </a></li>
<li class="toc-entry toc-h2"><a href="#Why-is-this-Important">Why is this Important </a></li>
<li class="toc-entry toc-h2"><a href="#Setup">Setup </a></li>
<li class="toc-entry toc-h2"><a href="#Finding-an-API-Endpoint">Finding an API Endpoint </a></li>
<li class="toc-entry toc-h2"><a href="#Reading-in-Data-via-API">Reading in Data via API </a></li>
<li class="toc-entry toc-h2"><a href="#Socrata-Query-Language-(SoQL)">Socrata Query Language (SoQL) </a>
<ul>
<li class="toc-entry toc-h3"><a href="#Example-1:-Simple-Filter">Example 1: Simple Filter </a></li>
<li class="toc-entry toc-h3"><a href="#Example-2:-Date-Filter">Example 2: Date Filter </a></li>
<li class="toc-entry toc-h3"><a href="#Example-3:-Toggling-Row-Limit">Example 3: Toggling Row Limit </a></li>
<li class="toc-entry toc-h3"><a href="#Example-4:-Select-Subset-of-Columns">Example 4: Select Subset of Columns </a></li>
<li class="toc-entry toc-h3"><a href="#Example-5:-Putting-it-All-Together-with-$query">Example 5: Putting it All Together with $query </a></li>
</ul>
</li>
</ul><!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2021-08-19-read-socrata.ipynb
-->

<div class="container" id="notebook-container">
        
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><img src="/the-city-scraper/images/copied_from_nb/../images/cincy_skyline.jpg" alt=""></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="In-this-Post">
<a class="anchor" href="#In-this-Post" aria-hidden="true"><span class="octicon octicon-link"></span></a>In this Post<a class="anchor-link" href="#In-this-Post"> </a>
</h2>
<p>Let's bring some first post energy!  I am excited to kick off this blog with a post about accessing Open Data in an easy, programmatic manner.</p>
<p>This notebook will demonstrate how to programatically read in Open Data from Socrata databases.  Socrata is a company commissioned by a large number of cities to host open data platforms.</p>
<p>These Open Data platforms are searchable and most importantly the data can be queried via an API.  These queries can be quite simple, or more complex.  We will dive into examples of both and be querying data in no time!</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Why-is-this-Important">
<a class="anchor" href="#Why-is-this-Important" aria-hidden="true"><span class="octicon octicon-link"></span></a>Why is this Important<a class="anchor-link" href="#Why-is-this-Important"> </a>
</h2>
<p>Querying and accessing data is a fundamental step of any data science workflow.  The mechanics of accessing data can get very messy, especially when it comes to government data.  Examples of this messiness include manually downloading files and saving to a user-defined location, appending multiple Excel files, scraping PDFs, and the list goes on.  Bottom line: it can get MESSY.</p>
<p>Luckily, the infrastructure provided by Socrata makes for a seamless experience that can be replicated by anyone with the Internet and Python.  You read that correctly, everything demonstrated in this post can be replicated with very little setup.  This is a huge perk for the sake of collaboration.  Additionally, in the event that an analysis needs to be re-run, perhaps on more recent data, the ability to query data programatically allows for minimal rework and minimal room for error.  Alright, enough hype let's get to it!</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Setup">
<a class="anchor" href="#Setup" aria-hidden="true"><span class="octicon octicon-link"></span></a>Setup<a class="anchor-link" href="#Setup"> </a>
</h2>
<p>Before we get rolling, it is important to be working in an environment with the necessary packages installed and available.  I like using Conda to manage environments (this sounds like a future blog post) and for the demonstration below it will be important to have pandas installed in your environment.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_text output_error">
<pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">ModuleNotFoundError</span>                       Traceback (most recent call last)
<span class="ansi-green-fg">&lt;ipython-input-1-45fa858dc579&gt;</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-intense-fg ansi-bold">      1</span> <span class="ansi-red-fg"># load pandas</span>
<span class="ansi-green-fg">----&gt; 2</span><span class="ansi-red-fg"> </span><span class="ansi-green-fg">import</span> pandas <span class="ansi-green-fg">as</span> pd

<span class="ansi-red-fg">ModuleNotFoundError</span>: No module named 'pandas'</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Finding-an-API-Endpoint">
<a class="anchor" href="#Finding-an-API-Endpoint" aria-hidden="true"><span class="octicon octicon-link"></span></a>Finding an API Endpoint<a class="anchor-link" href="#Finding-an-API-Endpoint"> </a>
</h2>
<p>Before we dive into actually reading data, it is important to know where to look for potential datasets.  Most cities have their Open Data tied to the city's website.  In this case we are going to explore the City of Cincinnati's Open Data Portal, which can be found at this <a href="https://data.cincinnati-oh.gov">link</a>.</p>
<p><img src="/the-city-scraper/images/copied_from_nb/../images/2021-08-19-open-data-portal.png" alt=""></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>At this point, we can navigate into one of the categories or search for a specific dataset.  In this case, we select the 'Safety' category and will then choose the Police Calls dataset.</p>
<p><img src="/the-city-scraper/images/copied_from_nb/../images/2021-08-19-safety-data.png" alt=""></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We are now able to Copy the API Endpoint by selecting the 'API' button and the 'Copy' button next to the endpoint.</p>
<p><img src="/the-city-scraper/images/copied_from_nb/../images/2021-08-19-PDI-endpoint.png" alt=""></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Reading-in-Data-via-API">
<a class="anchor" href="#Reading-in-Data-via-API" aria-hidden="true"><span class="octicon octicon-link"></span></a>Reading in Data via API<a class="anchor-link" href="#Reading-in-Data-via-API"> </a>
</h2>
<p>You might notice that the API endpoint is just a link - try accessing the link below in your browser.  You will notice that the result is just a JSON string in your browser - this is the data we are pulling in imminently!</p>
<p>In order to read this into a pandas DataFrame, we utilize the pandas <code>read_json</code> function.  This function only has one required argument, <code>path_or_buf</code> and we set the value to our API endpoint.  More information on <code>read_json</code> can be found by looking at its docstring (simply run <code>?read_json</code>).</p>
<p>Note that in this initial read, we only pull back 1,000 total rows.  This is the default response when no other parameters are added to the endpoint URL.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">crime_data_endpoint</span> <span class="o">=</span> <span class="s1">'https://data.cincinnati-oh.gov/resource/k59e-2pvf.json'</span>

<span class="n">pd</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="n">path_or_buf</span> <span class="o">=</span> <span class="n">crime_data_endpoint</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Socrata-Query-Language-(SoQL)">
<a class="anchor" href="#Socrata-Query-Language-(SoQL)" aria-hidden="true"><span class="octicon octicon-link"></span></a>Socrata Query Language (SoQL)<a class="anchor-link" href="#Socrata-Query-Language-(SoQL)"> </a>
</h2>
<p>In the above example, we simply query the entire dataset (albeit a sample of 1,000 rows) given we did not make any tweaks to the base URL.  However, we are able to arrive at fairly robust queries using the SoQL querying language. SoQL is a querying language developed by Socrata in order to make the process of requesting data via their API more efficient.  In their <a href="https://dev.socrata.com/docs/queries/">documentation</a> they mention their intentions of mirroring the spirit of SQL and I believe they accomplished that goal quite well.</p>
<p>Being well versed in this querying language provides enormous benefits in the case of processing time.  It is far more efficient to execute data processing against the Socrata servers prior to bringing in data to your local machine.  For the remainder of this post we will explore examples of utilizing SoQL queries to refine our data before pulling it into our local machines.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Example-1:-Simple-Filter">
<a class="anchor" href="#Example-1:-Simple-Filter" aria-hidden="true"><span class="octicon octicon-link"></span></a>Example 1: Simple Filter<a class="anchor-link" href="#Example-1:-Simple-Filter"> </a>
</h3>
<p>In our first example, we are going to execute a simple filter on our data by updating the <code>$WHERE</code> parameter.  As you would imagine, the default value for the <code>$WHERE</code> parameter is No Filter.</p>
<p>In our initial query above, we see that there is an <code>offense</code> column with a number of different values, stored as strings.  For this exercise, we are going to filter to instances where <code>offense</code> is equal to 'THEFT'.</p>
<p>In practice, we are able to execute this by modifying our API endpoint with the simple filter clause stamped on at the end.  To signal that we are going to add a SoQL clause to our endpoint, we first add a question mark (?) at the end of the initial endpoint, immediately following '.json':  <code>https://data.cincinnati-oh.gov/resource/k59e-2pvf.json?</code></p>
<p>Now, we must add the actual where clause.  In this case, we first declare that we are updating the <code>$WHERE</code> parameter by adding <code>where=</code>.  We now add the filter statement, in this case <code>offense = 'THEFT'</code>.  This gives us a final query that looks like the following:</p>
<p><code>https://data.cincinnati-oh.gov/resource/k59e-2pvf.json?$WHERE=offense='THEFT'</code>.
</p>
<div class="flash">
    <svg class="octicon octicon-info octicon octicon-info octicon octicon-info" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z"></path></svg>
    <strong>Note: </strong>from this point forward we will simply reference <code>crime_data_endpoint</code> when generating queries.  We will take advantage of f-String formatting that allows us to pass through a variable to a string statement (i.e. if <code>name</code> is a variable defined in the environment as the value of <code>&amp;#8217;Joe&amp;#8217;</code>, the statement <code>f"I am {name}"</code> will evaluate to <code>&amp;#8217;I am Joe&amp;#8217;</code>.
</div>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">crime_data_endpoint</span><span class="si">}</span><span class="s2">?$WHERE=offense='THEFT'"</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>With the query above, we see the data returned is exclusively limited to 'THEFT' offenses as desired.  We are now going to demonstrate the ability to string multiple <code>WHERE</code> clauses into the same query.</p>
<p>In order to do so, we tap into the logical operators allowed within the SoQL framework.  The following operators are available as illustrated in the <a href="https://dev.socrata.com/docs/queries/where.html">documentation</a>:</p>
<ul>
<li>
<code>AND</code> (&amp;)</li>
<li>
<code>OR</code> (|)</li>
<li><code>NOT</code></li>
<li><code>IS NULL</code></li>
<li><code>IS NOT NULL</code></li>
</ul>
<p>In this case, we are going to add the condition that an incident must have occurred in the <code>45202</code> zip code.  To accomplish this, we simply add the <code>&amp;</code> symbol and an additional condition of <code>zip=45202</code>.
</p>
<div class="flash">
    <svg class="octicon octicon-info octicon octicon-info octicon octicon-info octicon octicon-info" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z"></path></svg>
    <strong>Note: </strong>the SoQL documentation shows examples that include spaces in the endpoint URL.  The <code>pd.read_json()</code> function does not accept URLs with spaces.  Do your best to avoid using spaces, or replace the space with its URL encoding (in the case of a space that is <code>%20</code>).
</div>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">crime_data_endpoint</span><span class="si">}</span><span class="s2">?$WHERE=offense='THEFT'&amp;zip=45202"</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Example-2:-Date-Filter">
<a class="anchor" href="#Example-2:-Date-Filter" aria-hidden="true"><span class="octicon octicon-link"></span></a>Example 2: Date Filter<a class="anchor-link" href="#Example-2:-Date-Filter"> </a>
</h3>
<p>Working with dates can be finnicky in any scenario.  In this example, we aim to illustrate how to introduce a simple filter to limit the date range of our returned crime instances.</p>
<p>As you can see and infer from above, we have several fields that are represented as timestamps.  For this exercise, we are going to specifically focus on the <code>date_reported</code> field.  Let's explore how we would only look at records for which the <code>date_reported</code> value occurred within the last year.</p>
<p>For this exercise we will take advantage of the <code>datetime</code> library that assists with time and date operations.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">datetime</span> <span class="k">as</span> <span class="nn">dt</span>

<span class="c1"># dynamically generate today's date</span>
<span class="n">today</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span>

<span class="c1"># dynamically arrive at the date exactly 365 days ago</span>
<span class="n">year_ago_today</span> <span class="o">=</span> <span class="n">today</span> <span class="o">-</span> <span class="n">dt</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span> <span class="o">=</span> <span class="mi">365</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">year_ago_today</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now that we have our date for exactly one year ago, we can utilize it within our API call.  Similar to the simple filters above, we simply create a <code>$WHERE</code> clause, but in this case we look at instances where the <code>date_reported</code> field satisfies the condition of being after our <code>year_ago_today</code> value.
</p>
<div class="flash">
    <svg class="octicon octicon-info octicon octicon-info octicon octicon-info octicon octicon-info octicon octicon-info" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z"></path></svg>
    <strong>Note: </strong>it is important to enclose the value for <code>year_ago_today</code> in quotes.  In this case I use single quotes for within the query, and enclose the entire query using double quotes.
</div>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">crime_data_endpoint</span><span class="si">}</span><span class="s2">?$WHERE=date_reported&gt;='</span><span class="si">{</span><span class="n">year_ago_today</span><span class="si">}</span><span class="s2">'"</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Example-3:-Toggling-Row-Limit">
<a class="anchor" href="#Example-3:-Toggling-Row-Limit" aria-hidden="true"><span class="octicon octicon-link"></span></a>Example 3: Toggling Row Limit<a class="anchor-link" href="#Example-3:-Toggling-Row-Limit"> </a>
</h3>
<p>By default, the row limit returned by the Socrata API is 1,000.  This is great for datasets smaller than 1,000 rows and illustrative blog posts, but for anything that actually matters it will be woefully insufficient.  Hence, we will now walk through the means for adjusting the row limit and integrating this into our queries.</p>
<p>This mechanic is really quite straightforward.  Similar to other SoQL query arguments, we simply define the parameter we are adjusting by adding <code>$LIMIT</code>, and then specifying the value for which to limit the row counts.  In the example below we limit this to <code>10</code>, however, you could ramp it up as large or small as needed.
</p>
<div class="flash">
    <svg class="octicon octicon-info octicon octicon-info octicon octicon-info octicon octicon-info octicon octicon-info octicon octicon-info" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z"></path></svg>
    <strong>Note: </strong>I have not found an ’unlimited’ value for this argument, thus if I know I would like to return all records I simply pass through an uncharacteristically large value that would not be anywhere near the max size of the data.  This is not a perfect solution but gets the job done when you know the rough size of your data.
</div>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">crime_data_endpoint</span><span class="si">}</span><span class="s2">?$LIMIT=10"</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">crime_data_endpoint</span><span class="si">}</span><span class="s2">?$WHERE=offense='THEFT'&amp;$LIMIT=5"</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Example-4:-Select-Subset-of-Columns">
<a class="anchor" href="#Example-4:-Select-Subset-of-Columns" aria-hidden="true"><span class="octicon octicon-link"></span></a>Example 4: Select Subset of Columns<a class="anchor-link" href="#Example-4:-Select-Subset-of-Columns"> </a>
</h3>
<p>In this example we walkthrough the method for selecting only a subset of the columns in a dataframe.  This improves performance when you only need to work with a subset of columns by reducing the size of the dataframe.</p>
<p>The syntax is fairly straightforward and mirrors the methods for adding other parameters to our query.  Simply add a <code>$SELECT=</code> clause to the URL and list columns to include, separated by commas.
</p>
<div class="flash">
    <svg class="octicon octicon-info octicon octicon-info octicon octicon-info octicon octicon-info octicon octicon-info octicon octicon-info octicon octicon-info" viewbox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm6.5-.25A.75.75 0 017.25 7h1a.75.75 0 01.75.75v2.75h.25a.75.75 0 010 1.5h-2a.75.75 0 010-1.5h.25v-2h-.25a.75.75 0 01-.75-.75zM8 6a1 1 0 100-2 1 1 0 000 2z"></path></svg>
    <strong>Note: </strong>again, it is important to avoid spaces within the URL.  There is functionality to select columns under new names, like so: <code>$SELECT=suspect_gender AS gender</code>.  However, in this case we need to clean up the query to avoid any spaces in the URL by replacing them with the <code>%20</code> notation: <code>$SELECT=suspect_gender%20AS%20gender</code>.
</div>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">crime_data_endpoint</span><span class="si">}</span><span class="s2">?$SELECT=incident_no,date_reported,suspect_gender"</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Example-5:-Putting-it-All-Together-with-$query">
<a class="anchor" href="#Example-5:-Putting-it-All-Together-with-%24query" aria-hidden="true"><span class="octicon octicon-link"></span></a>Example 5: Putting it All Together with <code>$query</code><a class="anchor-link" href="#Example-5:-Putting-it-All-Together-with-%24query"> </a>
</h3>
<p>Up until this point, we have walked through the parameters that can be modified within a query on an individual basis.  It was noted that multiple parameters can be combined by adding an <code>&amp;</code> symbol between parameters, leading to more complex queries.  However, there is an easier way to string these parameters together, and it manifests itself within the <code>$query</code> parameter.</p>
<p>In these examples we will demonstrate how to string together a full-fledged query using the single <code>$query</code> parameter.  These queries will strongly resemble standard SQL queries that lack a <code>FROM</code> clause.</p>
<p>To make things simpler, I have created a function (<code>generate_query</code>) to take care of some of the less readable pieces of these queries, notably the requirement to replace spaces (<code>' '</code>) with <code>'%20'</code>.  Furthermore, this function breaks the components of the query into chunks, making it very human readable.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># function returns a full, cleaned up API call</span>
<span class="k">def</span> <span class="nf">generate_query</span><span class="p">(</span><span class="n">endpoint_url</span><span class="p">,</span> <span class="n">select_clause</span><span class="p">,</span> <span class="n">where_clause</span><span class="p">,</span> <span class="n">group_clause</span><span class="p">,</span> <span class="n">order_by_clause</span><span class="p">):</span>

    <span class="n">raw_query</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">endpoint_url</span><span class="si">}</span><span class="s2">?$query="</span>
                 <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">select_clause</span><span class="si">}</span><span class="s2">%20"</span>
                 <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">where_clause</span><span class="si">}</span><span class="s2">%20"</span>
                 <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">group_clause</span><span class="si">}</span><span class="s2">%20"</span>
                 <span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">order_by_clause</span><span class="si">}</span><span class="s2">"</span>
                <span class="p">)</span>
    
    <span class="n">final_query</span> <span class="o">=</span> <span class="nb">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">raw_query</span><span class="p">,</span> <span class="s2">" "</span><span class="p">,</span> <span class="s2">"%20"</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">final_query</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now, with our function in hand let's accomplish the following within two separate queries:</p>
<ol>
<li>Select the columns <code>date_reported</code> and <code>offense</code> for records where <code>suspect_gender</code> is 'MALE'</li>
<li>Count the number of records by offense type for all crimes within the past year, order by the count in descending order</li>
</ol>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">first_query</span> <span class="o">=</span> <span class="n">generate_query</span><span class="p">(</span><span class="n">endpoint_url</span> <span class="o">=</span> <span class="n">crime_data_endpoint</span><span class="p">,</span>
               <span class="n">select_clause</span> <span class="o">=</span> <span class="s2">"select date_reported, offense"</span><span class="p">,</span>
               <span class="n">where_clause</span> <span class="o">=</span> <span class="s2">"where offense = 'THEFT'"</span><span class="p">,</span>
               <span class="n">group_clause</span> <span class="o">=</span> <span class="s2">""</span><span class="p">,</span>
               <span class="n">order_by_clause</span> <span class="o">=</span> <span class="s2">""</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">first_query</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="n">first_query</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">##    order by the count in descending order</span>

<span class="n">second_query</span> <span class="o">=</span> <span class="n">generate_query</span><span class="p">(</span><span class="n">endpoint_url</span> <span class="o">=</span> <span class="n">crime_data_endpoint</span><span class="p">,</span>
                              <span class="n">select_clause</span> <span class="o">=</span> <span class="s2">"select offense, count(*) as n"</span><span class="p">,</span>
                              <span class="n">where_clause</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">"where date_reported&gt;='</span><span class="si">{</span><span class="n">year_ago_today</span><span class="si">}</span><span class="s2">'"</span><span class="p">,</span>
                              <span class="n">group_clause</span> <span class="o">=</span> <span class="s2">"group by offense"</span><span class="p">,</span>
                              <span class="n">order_by_clause</span> <span class="o">=</span> <span class="s2">"order by count(*) desc"</span>
                             <span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">second_query</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="n">second_query</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>And with that we conclude the first post of the blog!  I hope you found this information helpful and I can't wait to deliver more content that explores the intersection of cities and data science.</p>

</div>
</div>
</div>
</div>



  </div><!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js"
        repo="jmbahr/the-city-scraper"
        issue-term="title"
        label="blogpost-comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script><a class="u-url" href="/the-city-scraper/jupyter/2021/08/19/read-socrata.html" hidden></a>
</article>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/the-city-scraper/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/the-city-scraper/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/the-city-scraper/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>An exploration of Data Science topics through the lens of city data.</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/jmbahr" title="jmbahr"><svg class="svg-icon grey"><use xlink:href="/the-city-scraper/assets/minima-social-icons.svg#github"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
